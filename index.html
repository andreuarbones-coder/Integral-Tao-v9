<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Jardín OS v9.6</title>
    
    <!-- === MANIFIESTO PWA === -->
    <link rel="manifest" href='data:application/manifest+json,{"name":"Jardín OS","short_name":"Jardín OS","start_url":".","display":"standalone","background_color":"#1e293b","theme_color":"#0f172a","description":"Gestión Integral de Vivero","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/1598/1598196.png","sizes":"192x192","type":"image/png"}]}'>

    <!-- Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    
    <!-- Librerías -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Configuración Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        theme: {
                            centro: '#064e3b', centroLight: '#34d399',
                            ejemplares: '#312e81', ejemplaresLight: '#818cf8',
                            warning: '#f59e0b', danger: '#ef4444'
                        }
                    },
                    animation: {
                        'slide-in': 'slideIn 0.3s ease-out forwards',
                        'fade-in': 'fadeIn 0.2s ease-out forwards',
                    },
                    keyframes: {
                        slideIn: { '0%': { transform: 'translateX(-100%)' }, '100%': { transform: 'translateX(0)' } },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        /* CSS Core */
        :root { --app-height: 100dvh; --header-height: 64px; }
        body { 
            height: var(--app-height); overflow: hidden; 
            -webkit-tap-highlight-color: transparent; user-select: none;
            background-color: #f1f5f9;
        }
        
        /* Themes */
        body.branch-centro { --primary: #064e3b; --secondary: #ecfdf5; --accent: #10b981; }
        body.branch-ejemplares { --primary: #312e81; --secondary: #eef2ff; --accent: #6366f1; }
        
        /* Scrollbar Hide */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .scroll-area { height: calc(var(--app-height) - var(--header-height)); overflow-y: auto; padding-bottom: 80px; }

        /* Chat Bubbles */
        .msg-bubble { max-width: 85%; border-radius: 16px; padding: 12px; margin-bottom: 8px; position: relative; word-wrap: break-word; }
        .msg-me { background-color: var(--secondary); margin-left: auto; color: var(--primary); border-bottom-right-radius: 4px; border: 1px solid rgba(0,0,0,0.05); }
        .msg-other { background-color: white; margin-right: auto; color: #334155; border-bottom-left-radius: 4px; border: 1px solid #e2e8f0; }

        /* Loader */
        .spinner { border: 3px solid rgba(0,0,0,0.1); border-left-color: var(--accent); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Toast Positioned Top Center */
        #toast-container { position: fixed; top: 90px; left: 50%; transform: translateX(-50%); z-index: 9999; pointer-events: none; width: auto; max-width: 90%; display: flex; flex-col-reverse; align-items: center; }
        .toast { pointer-events: auto; animation: fade-in-down 0.3s ease-out; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(4px); color: white; padding: 10px 20px; border-radius: 50px; font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 10px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2); margin-bottom: 8px; border: 1px solid rgba(255,255,255,0.1); }
        @keyframes fade-in-down { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body id="appBody" class="branch-centro transition-colors duration-500 font-sans text-slate-800">

    <!-- === DATALIST FOR AUTOCOMPLETE === -->
    <datalist id="stockItemsList"></datalist>

    <!-- === SIDEBAR NAVIGATION === -->
    <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-40 hidden transition-opacity duration-300 opacity-0" onclick="UI.toggleSidebar(false)"></div>
    <aside id="sidebar" class="fixed top-0 left-0 h-full w-72 bg-white z-50 transform -translate-x-full transition-transform duration-300 shadow-2xl flex flex-col">
        <div class="p-6 text-white" style="background-color: var(--primary);">
            <div class="flex items-center gap-3 mb-2">
                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                    <i class="fas fa-seedling text-xl"></i>
                </div>
                <div>
                    <h2 class="font-bold text-lg leading-tight">Jardín OS</h2>
                    <p class="text-xs opacity-80 font-mono">v9.6</p>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t border-white/20">
                <p class="text-xs font-bold uppercase opacity-60 mb-1">Sucursal Actual</p>
                <button id="branchToggleBtn" class="flex items-center justify-between w-full bg-black/20 p-2 rounded-lg hover:bg-black/30 transition">
                    <span id="sidebarBranchName" class="font-bold">Centro Tao</span>
                    <i class="fas fa-exchange-alt opacity-70"></i>
                </button>
            </div>
        </div>
        
        <nav class="flex-grow overflow-y-auto py-4">
            <ul class="space-y-1">
                <li><button onclick="UI.nav('tasks')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-50 flex items-center gap-4 text-slate-600 font-medium border-l-4 border-transparent active-nav"><i class="fas fa-tasks w-5"></i> Tareas</button></li>
                <li><button onclick="UI.nav('orders')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-50 flex items-center gap-4 text-slate-600 font-medium border-l-4 border-transparent"><i class="fas fa-shopping-basket w-5"></i> Pedidos <span id="badgeOrders" class="hidden bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full ml-auto">!</span></button></li>
                <li><button onclick="UI.nav('delivery')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-50 flex items-center gap-4 text-slate-600 font-medium border-l-4 border-transparent"><i class="fas fa-truck w-5"></i> Repartos <span id="badgeDelivery" class="hidden bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full ml-auto">!</span></button></li>
                <li><button onclick="UI.nav('standards')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-50 flex items-center gap-4 text-slate-600 font-medium border-l-4 border-transparent"><i class="fas fa-ruler-combined w-5"></i> Catálogo</button></li>
                <li><button onclick="UI.nav('stock')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-50 flex items-center gap-4 text-slate-600 font-medium border-l-4 border-transparent"><i class="fas fa-boxes w-5"></i> Stock (Lista)</button></li>
                <li><button onclick="UI.nav('scripts')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-50 flex items-center gap-4 text-slate-600 font-medium border-l-4 border-transparent"><i class="fas fa-comment-dots w-5"></i> Scripts Venta</button></li>
                <li><button onclick="UI.nav('procedures')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-50 flex items-center gap-4 text-slate-600 font-medium border-l-4 border-transparent"><i class="fas fa-book w-5"></i> Procesos</button></li>
                <li><button onclick="UI.nav('notes')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-50 flex items-center gap-4 text-slate-600 font-medium border-l-4 border-transparent"><i class="fas fa-sticky-note w-5"></i> Notas</button></li>
                <li><button onclick="UI.nav('chat')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-50 flex items-center gap-4 text-slate-600 font-medium border-l-4 border-transparent"><i class="fas fa-walkie-talkie w-5"></i> Radio</button></li>
            </ul>
        </nav>

        <div class="p-4 border-t border-slate-100 space-y-2">
            <button onclick="window.downloadBackup()" class="w-full py-2 px-3 rounded-lg bg-blue-50 text-blue-600 text-xs font-bold flex items-center justify-center gap-2 hover:bg-blue-100">
                <i class="fas fa-cloud-download-alt"></i> <span>Backup de Datos</span>
            </button>
            <button id="wakeLockBtn" class="w-full py-2 px-3 rounded-lg bg-slate-100 text-slate-500 text-xs font-bold flex items-center justify-center gap-2 transition-colors">
                <i class="far fa-moon"></i> <span>Pantalla: Automática</span>
            </button>
            <div class="text-center mt-2 text-[10px] text-slate-400" id="connectionStatus">Conectado</div>
        </div>
    </aside>

    <!-- === MAIN LAYOUT === -->
    <div class="flex flex-col h-full w-full relative">
        
        <!-- HEADER -->
        <header class="flex-none h-[64px] shadow-md flex items-center justify-between px-4 z-20 text-white transition-colors duration-500" style="background-color: var(--primary);">
            <div class="flex items-center gap-3">
                <button onclick="UI.toggleSidebar(true)" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-white/10 active:scale-95 transition">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <div>
                    <h1 id="pageTitle" class="font-bold text-lg leading-none">Mis Tareas</h1>
                    <span id="currentDate" class="text-xs opacity-80 capitalize">Cargando...</span>
                </div>
            </div>
            <div class="flex items-center gap-2">
                 <div id="loadingIndicator" class="hidden spinner border-white/30 border-l-white"></div>
            </div>
        </header>

        <!-- CONTENT AREA -->
        <main id="mainContainer" class="flex-grow relative bg-slate-100 overflow-hidden">
            
            <!-- VIEW: TASKS -->
            <div id="view-tasks" class="view-section scroll-area p-4">
                <div id="taskList" class="space-y-3 pb-24">
                    <div class="animate-pulse bg-white h-24 rounded-xl"></div>
                </div>
            </div>

            <!-- VIEW: STANDARDS -->
            <div id="view-standards" class="view-section scroll-area hidden p-4">
                <div class="sticky top-0 bg-slate-100 z-10 pb-4">
                    <div class="relative">
                        <i class="fas fa-search absolute left-4 top-3.5 text-slate-400"></i>
                        <input type="text" id="stdSearch" class="w-full p-3 pl-10 rounded-xl border border-slate-300 shadow-sm outline-none focus:ring-2 focus:ring-emerald-500 transition-all" placeholder="Buscar especie (ej: Ceibo)...">
                    </div>
                </div>
                <div id="standardsList" class="space-y-6 pb-24"></div>
                <button onclick="UI.openModal('modal-standards')" class="w-full py-3 bg-white border-2 border-dashed border-slate-300 text-slate-500 font-bold rounded-xl hover:border-emerald-500 hover:text-emerald-600 transition">+ Agregar Nueva Planta</button>
            </div>

            <!-- VIEW: ORDERS (PEDIDOS) -->
            <div id="view-orders" class="view-section scroll-area hidden p-4">
                <div class="bg-blue-50 border border-blue-200 text-blue-800 p-3 rounded-xl mb-4 text-sm flex items-center justify-center gap-2 text-center">
                    <i class="fas fa-info-circle"></i> Canal compartido de pedidos de stock
                </div>
                <div id="ordersList" class="space-y-3 pb-24"></div>
            </div>

            <!-- VIEW: DELIVERY -->
            <div id="view-delivery" class="view-section scroll-area hidden p-4">
                <div id="deliveryList" class="space-y-4 pb-24"></div>
            </div>

            <!-- VIEW: SCRIPTS -->
            <div id="view-scripts" class="view-section scroll-area hidden p-4">
                <div class="bg-purple-50 text-purple-800 text-sm p-3 rounded-xl mb-4 border border-purple-200 flex gap-2 items-center">
                    <i class="fas fa-lightbulb text-lg"></i>
                    <span>Toca el botón copiar para usar estos guiones en tus chats de venta.</span>
                </div>
                <div id="scriptsList" class="space-y-4 pb-24"></div>
            </div>

            <!-- VIEW: NOTES -->
            <div id="view-notes" class="view-section scroll-area hidden p-4">
                <div id="notesList" class="grid gap-4 pb-24"></div>
            </div>

            <!-- VIEW: PROCEDURES -->
            <div id="view-procedures" class="view-section scroll-area hidden p-4">
                <div id="proceduresList" class="space-y-4 pb-24"></div>
            </div>

            <!-- VIEW: STOCK -->
            <div id="view-stock" class="view-section scroll-area hidden p-4">
                <div class="sticky top-0 bg-slate-100 z-10 pb-4">
                     <div class="relative">
                        <i class="fas fa-search absolute left-4 top-3.5 text-slate-400"></i>
                        <input type="text" id="stockSearchInput" oninput="window.renderStockList(this.value)" class="w-full p-3 pl-10 rounded-xl border border-slate-300 shadow-sm outline-none focus:ring-2 focus:ring-emerald-500 transition-all" placeholder="Buscar en lista de stock...">
                    </div>
                </div>
                <div id="stockListContainer" class="bg-white rounded-xl shadow-sm border border-slate-200 divide-y divide-slate-100 pb-24">
                    <!-- Stock items go here -->
                </div>
            </div>

            <!-- VIEW: CHAT -->
            <div id="view-chat" class="view-section hidden h-full flex flex-col">
                <div id="chatList" class="flex-grow overflow-y-auto p-4 space-y-2 pb-4"></div>
                <div class="p-3 bg-white border-t border-slate-200 flex items-center gap-2 pb-[max(12px,env(safe-area-inset-bottom))]">
                     <button onclick="document.getElementById('chatImageInput').click()" class="p-3 text-slate-400 hover:text-emerald-600"><i class="fas fa-camera text-xl"></i></button>
                     <input type="file" id="chatImageInput" accept="image/*" class="hidden" onchange="window.handleChatImage(this)">
                     <div class="flex-grow bg-slate-100 rounded-full px-4 py-2">
                        <input type="text" id="chatTextInput" class="w-full bg-transparent outline-none" placeholder="Mensaje...">
                     </div>
                     <button id="sendChatBtn" class="text-slate-500 p-3"><i class="fas fa-paper-plane text-lg"></i></button>
                     <button id="micBtn" class="w-10 h-10 rounded-full bg-red-500 text-white flex items-center justify-center shadow-lg active:scale-95"><i class="fas fa-microphone"></i></button>
                </div>
            </div>

        </main>

        <!-- FAB -->
        <div id="fabContainer" class="fixed bottom-6 right-6 z-30 transition-transform duration-300 pb-[env(safe-area-inset-bottom)]">
            <button id="mainFab" class="w-14 h-14 rounded-full text-white shadow-xl flex items-center justify-center text-2xl active:scale-90 transition-transform hover:shadow-2xl" style="background-color: var(--accent);">
                <i class="fas fa-plus"></i>
            </button>
        </div>

    </div>

    <!-- === MODALS === -->
    <div id="modalOverlay" class="hidden fixed inset-0 bg-black/60 z-50 flex items-end sm:items-center justify-center sm:p-4 backdrop-blur-sm">
        
        <!-- MODAL: NAME SETUP -->
        <div id="modal-username" class="bg-white w-full sm:max-w-xs sm:rounded-2xl rounded-t-2xl shadow-2xl overflow-hidden hidden transform transition-transform duration-300 z-50">
            <div class="p-6 text-center">
                <div class="w-16 h-16 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                    <i class="fas fa-user"></i>
                </div>
                <h2 class="text-xl font-bold text-slate-800 mb-2">¡Hola!</h2>
                <p class="text-slate-500 text-sm mb-4">Para que el equipo sepa quién eres, por favor ingresa tu primer nombre.</p>
                <input type="text" id="usernameInput" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none text-center font-bold mb-4" placeholder="Tu Nombre">
                <button id="saveUsernameBtn" class="w-full py-3 bg-emerald-600 text-white rounded-xl font-bold shadow-lg">Comenzar</button>
            </div>
        </div>

        <!-- MODAL: STANDARDS -->
        <div id="modal-standards" class="bg-white w-full sm:max-w-md sm:rounded-2xl rounded-t-2xl shadow-2xl overflow-hidden hidden transform transition-transform duration-300 translate-y-full sm:translate-y-0">
            <div class="p-5">
                <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="fas fa-ruler-combined text-emerald-600"></i> Definir Estándar</h2>
                <input type="hidden" id="stdId">
                <div class="space-y-4">
                    <div class="border-2 border-dashed border-slate-300 rounded-xl p-4 text-center cursor-pointer hover:border-emerald-400 hover:bg-emerald-50 transition relative" onclick="document.getElementById('stdPhotoInput').click()">
                        <input type="file" id="stdPhotoInput" accept="image/*" class="hidden" onchange="window.previewStdImage(this)">
                        <div id="stdPhotoPreview" class="hidden w-full h-40 bg-cover bg-center rounded-lg shadow-sm"></div>
                        <div id="stdPhotoPlaceholder" class="flex flex-col items-center justify-center py-2 text-slate-400">
                            <i class="fas fa-camera text-3xl mb-2"></i>
                            <span class="text-sm font-bold">Toca para subir Foto Testigo</span>
                        </div>
                    </div>
                    <div><label class="text-xs font-bold text-slate-400 uppercase ml-1">Especie</label><input type="text" id="stdSpecies" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none font-bold" placeholder="Ej: Jazmín del Cabo"></div>
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">Tamaño</label>
                        <div class="flex gap-2 overflow-x-auto no-scrollbar py-1">
                            <label class="cursor-pointer"><input type="radio" name="stdSize" value="T1" class="peer sr-only" checked><div class="px-4 py-2 bg-slate-100 rounded-lg text-slate-500 font-bold peer-checked:bg-emerald-600 peer-checked:text-white transition">T1</div></label>
                            <label class="cursor-pointer"><input type="radio" name="stdSize" value="T2" class="peer sr-only"><div class="px-4 py-2 bg-slate-100 rounded-lg text-slate-500 font-bold peer-checked:bg-emerald-600 peer-checked:text-white transition">T2</div></label>
                            <label class="cursor-pointer"><input type="radio" name="stdSize" value="T3" class="peer sr-only"><div class="px-4 py-2 bg-slate-100 rounded-lg text-slate-500 font-bold peer-checked:bg-emerald-600 peer-checked:text-white transition">T3</div></label>
                            <label class="cursor-pointer"><input type="radio" name="stdSize" value="T4" class="peer sr-only"><div class="px-4 py-2 bg-slate-100 rounded-lg text-slate-500 font-bold peer-checked:bg-emerald-600 peer-checked:text-white transition">T4</div></label>
                            <label class="cursor-pointer"><input type="radio" name="stdSize" value="T5" class="peer sr-only"><div class="px-4 py-2 bg-slate-100 rounded-lg text-slate-500 font-bold peer-checked:bg-emerald-600 peer-checked:text-white transition">T5</div></label>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-xs font-bold text-slate-400 uppercase ml-1">Altura</label><input type="text" id="stdHeight" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none" placeholder="Ej: 80cm"></div>
                        <div><label class="text-xs font-bold text-slate-400 uppercase ml-1">Tronco</label><input type="text" id="stdDiameter" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none" placeholder="Ej: 3cm"></div>
                    </div>
                </div>
                <button id="saveStdBtn" class="w-full mt-6 py-3.5 bg-emerald-600 text-white rounded-xl shadow-lg font-bold active:scale-95 transition-transform">Guardar Estándar</button>
            </div>
        </div>

        <!-- MODAL: TASK -->
        <div id="modal-tasks" class="bg-white w-full sm:max-w-md sm:rounded-2xl rounded-t-2xl shadow-2xl overflow-hidden hidden transform transition-transform duration-300 translate-y-full sm:translate-y-0">
            <div class="p-5">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-slate-800" id="taskModalTitle">Nueva Tarea</h2>
                    <button class="modal-close text-slate-400"><i class="fas fa-times"></i></button>
                </div>
                <input type="hidden" id="taskId">
                <div class="space-y-4">
                    <input type="text" id="taskInput" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none focus:border-emerald-500 font-medium" placeholder="Descripción de la tarea">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="taskAssignee" class="p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none text-sm" placeholder="Responsable">
                        <select id="taskPriority" class="p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none text-sm font-bold text-slate-600">
                            <option value="low">Baja</option>
                            <option value="medium">Media</option>
                            <option value="high">Alta</option>
                            <option value="critical">URGENTE</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">Repetición</label>
                        <div class="flex items-center gap-2 mt-1 bg-slate-50 p-2 rounded-xl border border-slate-200">
                            <div class="bg-indigo-100 text-indigo-600 w-8 h-8 rounded-lg flex items-center justify-center"><i class="fas fa-sync-alt"></i></div>
                            <select id="taskCycle" class="bg-transparent w-full outline-none text-sm font-medium text-slate-700">
                                <option value="none">No cíclica (Una vez)</option>
                                <option value="daily">Todos los días</option>
                                <option value="weekly">Semanal</option>
                                <option value="monthly">Mensual</option>
                            </select>
                        </div>
                    </div>
                </div>
                <button id="saveTaskBtn" class="w-full mt-6 py-3.5 text-white rounded-xl shadow-lg font-bold text-lg active:scale-95 transition-transform" style="background-color: var(--primary);">Guardar Tarea</button>
                <button id="deleteTaskBtn" class="w-full mt-2 py-3 text-red-500 font-bold bg-white border border-red-100 rounded-xl hidden hover:bg-red-50 active:scale-95 transition-transform">Eliminar Tarea</button>
            </div>
        </div>

        <!-- MODAL: ORDER & DELIVERY (SHARED STRUCTURE) -->
        <div id="modal-orders" class="bg-white w-full sm:max-w-md sm:rounded-2xl rounded-t-2xl shadow-2xl overflow-hidden hidden transform transition-transform duration-300 translate-y-full sm:translate-y-0">
            <div class="p-5 flex flex-col h-[80vh] sm:h-auto">
                <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2 flex-none" id="orderModalTitle"><i class="fas fa-shopping-basket text-blue-600"></i> Nuevo Pedido</h2>
                
                <div class="flex-grow overflow-y-auto pr-2 space-y-2 mb-4" id="orderItemsContainer">
                    <!-- Dynamic Rows -->
                </div>
                
                <button onclick="window.addOrderRow()" class="mb-4 py-2 px-4 rounded-lg border-2 border-dashed border-slate-300 text-slate-500 font-bold hover:border-blue-400 hover:text-blue-500 transition-colors w-full">+ Agregar Ítem</button>

                <div class="flex-none space-y-3">
                    <input type="text" id="orderRequester" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none text-sm" placeholder="¿Quién solicita?">
                    <textarea id="orderNotes" rows="2" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none text-sm" placeholder="Notas/Comentarios (opcional)"></textarea>
                    <button id="saveOrderBtn" class="w-full py-3.5 bg-blue-600 text-white rounded-xl shadow-lg font-bold active:scale-95">Confirmar</button>
                </div>
            </div>
        </div>

        <!-- MODAL: DELIVERY (NOW REUSES ORDER LOGIC MODIFIED) -->
        <div id="modal-delivery" class="bg-white w-full sm:max-w-md sm:rounded-2xl rounded-t-2xl shadow-2xl overflow-hidden hidden transform transition-transform duration-300 translate-y-full sm:translate-y-0">
            <div class="p-5 flex flex-col h-[80vh] sm:h-auto">
                <h2 class="text-xl font-bold text-slate-800 mb-4 flex-none" id="delModalTitle">Nuevo Reparto</h2>
                
                <input type="hidden" id="delId">

                <div class="flex-none space-y-3 mb-4">
                    <input type="text" id="delClient" class="w-full p-3 bg-slate-50 rounded-xl outline-none border border-slate-200" placeholder="Cliente">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="tel" id="delPhone" class="p-3 bg-slate-50 rounded-xl outline-none border border-slate-200 text-sm" placeholder="Teléfono">
                        <input type="text" id="delWhen" class="p-3 bg-slate-50 rounded-xl outline-none border border-slate-200 text-sm" placeholder="Horario">
                    </div>
                    <input type="text" id="delWhere" class="w-full p-3 bg-slate-50 rounded-xl outline-none border border-slate-200 text-sm" placeholder="Dirección">
                </div>

                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Items a entregar</label>
                <div class="flex-grow overflow-y-auto pr-2 space-y-2 mb-4" id="delItemsContainer">
                    <!-- Dynamic Rows -->
                </div>
                <button onclick="window.addOrderRow('delItemsContainer')" class="mb-4 py-2 px-4 rounded-lg border-2 border-dashed border-slate-300 text-slate-500 font-bold hover:border-indigo-400 hover:text-indigo-500 transition-colors w-full">+ Agregar Ítem</button>

                <div class="flex-none">
                    <textarea id="delNotes" rows="2" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none text-sm mb-3" placeholder="Comentarios del reparto (Timbre, etc)"></textarea>
                    <button id="saveDelBtn" class="w-full py-3.5 bg-indigo-600 text-white rounded-xl shadow-lg font-bold active:scale-95">Agendar Reparto</button>
                </div>
            </div>
        </div>

        <!-- MODAL: SCRIPT -->
        <div id="modal-scripts" class="bg-white w-full sm:max-w-md sm:rounded-2xl rounded-t-2xl shadow-2xl overflow-hidden hidden transform transition-transform duration-300 translate-y-full sm:translate-y-0">
            <div class="p-5">
                <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="fas fa-comment-dots text-purple-600"></i> Nuevo Script</h2>
                <div class="space-y-4">
                    <input type="text" id="scriptTitle" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none font-bold" placeholder="Título (ej: Saludo Inicial)">
                    <textarea id="scriptContent" rows="6" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none text-sm leading-relaxed" placeholder="Escribe el guion aquí..."></textarea>
                </div>
                <button id="saveScriptBtn" class="w-full mt-6 py-3.5 bg-purple-600 text-white rounded-xl shadow-lg font-bold active:scale-95">Guardar Guion</button>
            </div>
        </div>

         <!-- MODAL: NOTES -->
        <div id="modal-notes" class="bg-yellow-50 w-full sm:max-w-md sm:rounded-2xl rounded-t-2xl shadow-2xl border-t-4 border-yellow-400 hidden transform transition-transform duration-300 translate-y-full sm:translate-y-0">
            <div class="p-5">
                <h2 class="text-xl font-bold text-yellow-800 mb-4">Nueva Nota</h2>
                <select id="noteType" class="w-full p-2 mb-4 bg-yellow-100 border-none rounded text-yellow-900 font-bold"><option value="normal">General</option><option value="billing">Cobranza $$</option></select>
                <textarea id="noteContent" rows="6" class="w-full bg-transparent text-xl text-slate-700 placeholder-yellow-800/30 outline-none leading-relaxed" placeholder="Escribe aquí..."></textarea>
                <div class="flex gap-2 mt-4">
                    <button class="modal-close flex-1 py-3 text-yellow-700 font-bold">Cancelar</button>
                    <button id="saveNoteBtn" class="flex-1 py-3 bg-yellow-400 text-yellow-900 rounded-xl font-bold shadow-sm">Pegar Nota</button>
                </div>
            </div>
        </div>

        <!-- MODAL: PROCEDURES -->
         <div id="modal-procedures" class="bg-white w-full sm:max-w-md sm:rounded-2xl rounded-t-2xl shadow-2xl hidden transform transition-transform duration-300 translate-y-full sm:translate-y-0">
            <div class="p-5">
                <h2 class="text-xl font-bold text-slate-800 mb-4">Nuevo Proceso</h2>
                <input type="text" id="procTitle" class="w-full p-3 mb-3 bg-slate-50 rounded-xl border border-slate-200 outline-none font-bold" placeholder="Título del Protocolo">
                <textarea id="procSteps" rows="5" class="w-full p-3 mb-4 bg-slate-50 rounded-xl border border-slate-200 outline-none text-sm" placeholder="- Paso 1&#10;- Paso 2..."></textarea>
                <div class="flex flex-wrap justify-between gap-2 mb-6 px-2">
                    <label class="cursor-pointer"><input type="radio" name="procColor" value="blue" checked class="peer sr-only"><div class="w-8 h-8 rounded-full bg-blue-500 border-2 border-transparent peer-checked:ring-2 peer-checked:ring-offset-2 ring-blue-400"></div></label>
                    <label class="cursor-pointer"><input type="radio" name="procColor" value="green" class="peer sr-only"><div class="w-8 h-8 rounded-full bg-emerald-500 border-2 border-transparent peer-checked:ring-2 peer-checked:ring-offset-2 ring-emerald-400"></div></label>
                    <label class="cursor-pointer"><input type="radio" name="procColor" value="red" class="peer sr-only"><div class="w-8 h-8 rounded-full bg-red-500 border-2 border-transparent peer-checked:ring-2 peer-checked:ring-offset-2 ring-red-400"></div></label>
                    <label class="cursor-pointer"><input type="radio" name="procColor" value="purple" class="peer sr-only"><div class="w-8 h-8 rounded-full bg-purple-500 border-2 border-transparent peer-checked:ring-2 peer-checked:ring-offset-2 ring-purple-400"></div></label>
                    <label class="cursor-pointer"><input type="radio" name="procColor" value="pink" class="peer sr-only"><div class="w-8 h-8 rounded-full bg-pink-500 border-2 border-transparent peer-checked:ring-2 peer-checked:ring-offset-2 ring-pink-400"></div></label>
                    <label class="cursor-pointer"><input type="radio" name="procColor" value="teal" class="peer sr-only"><div class="w-8 h-8 rounded-full bg-teal-500 border-2 border-transparent peer-checked:ring-2 peer-checked:ring-offset-2 ring-teal-400"></div></label>
                    <label class="cursor-pointer"><input type="radio" name="procColor" value="slate" class="peer sr-only"><div class="w-8 h-8 rounded-full bg-slate-600 border-2 border-transparent peer-checked:ring-2 peer-checked:ring-offset-2 ring-slate-400"></div></label>
                </div>
                <button id="saveProcBtn" class="w-full py-3 bg-slate-800 text-white rounded-xl font-bold">Guardar Protocolo</button>
            </div>
        </div>

    </div>

    <!-- TOAST CONTAINER -->
    <div id="toast-container"></div>

    <!-- LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, getDocs, onSnapshot, serverTimestamp, query, orderBy, where, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // CONFIG
        const manualConfig = { apiKey: "AIzaSyBzPiBCgiHoHSp24U7739fj9-htyTA8KiU", authDomain: "app-jardin-v4.firebaseapp.com", projectId: "app-jardin-v4", storageBucket: "app-jardin-v4.firebasestorage.app", messagingSenderId: "413324369604", appId: "1:413324369604:web:f78e3f459725dd824e3391" };
        let firebaseConfig = null;
        try { if (typeof __firebase_config !== 'undefined' && __firebase_config) firebaseConfig = JSON.parse(__firebase_config); else if (typeof manualConfig !== 'undefined') firebaseConfig = manualConfig; } catch(e) {}
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        // --- CRITICAL PERSISTENCE FIX ---
        // We revert to the original ID where your data likely lives
        const APP_ID = 'jardin-os-v5'; 

        // === STOCK DATA (FULL FROM EXCEL) ===
        const STOCK_DATA = [
            "HORMIGUICIDA MIREX X 500 GR","AGLAONEMA BAHIA DE PLATA M12","ALOE VERA M12","MACETA COMUN 24","OPUNTIA T1","DENIS 35","HELECHO MACHO M 35",
            "CEBOLLA DE LA SUERTE CHICA","CUADRO 31X31 SIN PLANTA","SUSTRATO DE FLORACION 10 DM","SUSTRATO VEGETATIVO 10 DM","SANSEVIERIA T2",
            "FERTILIZANTE LIQUIDO","TUTOR DE MUSGO","MACETA PLASTICO N12","MACETA BARRO N15","SEMILLAS DE HUERTA","TIERRA FERTIL 25L",
            "LOMBRICOMPUESTO 5L","PERLITA AGRICOLA","TURBA RUBIA","FUNGICIDA SISTEMICO","INSECTICIDA DIMETOATO","GLIFOSATO",
            "JAZMIN DEL CABO T3","JAZMIN DEL PAIS T1","ROSA SEVILLANA","ROSA TREPADORA","ROSA ICEBERG","LAVANDA DENTATA",
            "ROMERO","MENTA","ALBAHACA","CIBOULETTE","OREGANO","PEREJIL","TOMILLO","SALVIA","RUDA MACHO","RUDA HEMBRA",
            "LIMONERO 4 ESTACIONES","NARANJO OMBLIGO","MANDARINO CRIOLLO","DURAZNERO","CIRUELO","MANZANO","PERAL",
            "FICUS BENJAMINA","PALMERA ARECA","PALMERA PHOENIX","DRACENA MARGINATA","DRACENA MASSANGEANA","POTOS TUTOR",
            "LAZOS DE AMOR","MONSTERA DELICIOSA","FILODENDRO PARAGUAYO","CALATHEA","CROTOS","DIEFFENBACHIA","SPATHIPHYLLUM",
            "ANTURIO ROJO","ORQUIDEA PHALAENOPSIS","VIOLETA DE LOS ALPES","PRIMULA","PENSAMIENTO","PETUNIA","ALEGRIA DEL HOGAR",
            "MALVON","GERANIO","AZALEA","CAMELIA","HORTENSIA","CORAL","DURANTA AUREA","BUXUS","EUGENIA","LAUREL DE COMER",
            "JAZMIN CHINO","JAZMIN AZORICO","KIMBERLY","HELECHO SERRUCHO","HELECHO PLUMOSO","CLIVIA","AGAPANTHUS",
            "HEMEROCALLIS","IRIS GERMANICA","CALA BLANCA","CALA DE COLOR","EQUISETUM","PAPIRO","NENUFAR","ACUATICAS VARIAS",
            "MACETA CUBO 40X40","MACETA JARDINERA 60CM","MACETA CILINDRO 30X40","PIEDRA BOLA BLANCA","PIEDRA BOLA GRIS",
            "CORTEZA DE PINO","CHIPS DE MADERA","DECORACION JARDIN","HERRAMIENTAS PALA","HERRAMIENTAS RASTRILLO","PODADORA DE MANO"
        ];
        
        // Populate Datalist
        const datalist = document.getElementById('stockItemsList');
        STOCK_DATA.forEach(item => {
            const option = document.createElement('option');
            option.value = item;
            datalist.appendChild(option);
        });

        // STATE
        const State = {
            user: null,
            username: localStorage.getItem('jardin_username') || '',
            branch: localStorage.getItem('tao_branch') || 'centro',
            view: 'tasks',
            wakeLock: null,
            listeners: {}
        };

        // UI MANAGER
        const UI = {
            init() {
                this.setBranch(State.branch);
                this.nav('tasks');
                document.getElementById('currentDate').innerText = new Date().toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'short' });
                
                if (!State.username) setTimeout(() => document.getElementById('modal-username').classList.remove('hidden'), 500);

                // Listeners
                document.getElementById('branchToggleBtn').onclick = () => this.toggleBranch();
                document.querySelectorAll('.modal-close').forEach(b => b.onclick = () => this.closeModal());
                document.getElementById('modalOverlay').onclick = (e) => { if(e.target === document.getElementById('modalOverlay')) this.closeModal(); };
                document.getElementById('mainFab').onclick = () => this.handleFab();
                document.getElementById('stdSearch').oninput = (e) => this.filterStandards(e.target.value);
                
                document.getElementById('wakeLockBtn').onclick = () => this.toggleWakeLock();
                document.getElementById('saveUsernameBtn').onclick = () => {
                    const name = document.getElementById('usernameInput').value.trim();
                    if(name) {
                        localStorage.setItem('jardin_username', name);
                        State.username = name;
                        document.getElementById('modal-username').classList.add('hidden');
                        this.toast(`Bienvenido, ${name}`);
                    }
                };

                // Render initial stock list
                this.renderStockList('');
            },

            setBranch(branch) {
                State.branch = branch;
                localStorage.setItem('tao_branch', branch);
                const body = document.getElementById('appBody');
                const label = document.getElementById('sidebarBranchName');
                
                if (branch === 'centro') {
                    body.className = 'branch-centro transition-colors duration-500 font-sans text-slate-800';
                    label.innerText = 'Centro Tao';
                } else {
                    body.className = 'branch-ejemplares transition-colors duration-500 font-sans text-slate-800';
                    label.innerText = 'Ejemplares Tao';
                }
                
                if(State.user) Data.resubscribe();
                this.toast(`Cambiado a ${label.innerText}`);
            },

            toggleBranch() { this.setBranch(State.branch === 'centro' ? 'ejemplares' : 'centro'); },

            toggleSidebar(show) {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebarOverlay');
                if (show) {
                    overlay.classList.remove('hidden');
                    void overlay.offsetWidth; 
                    overlay.classList.remove('opacity-0');
                    sidebar.classList.remove('-translate-x-full');
                } else {
                    overlay.classList.add('opacity-0');
                    sidebar.classList.add('-translate-x-full');
                    setTimeout(() => overlay.classList.add('hidden'), 300);
                }
            },
            
            async toggleWakeLock() {
                const btn = document.getElementById('wakeLockBtn');
                try {
                    if (State.wakeLock) {
                        await State.wakeLock.release();
                        State.wakeLock = null;
                        btn.classList.remove('bg-emerald-100', 'text-emerald-700');
                        btn.classList.add('bg-slate-100', 'text-slate-500');
                        btn.innerHTML = '<i class="far fa-moon"></i> <span>Pantalla: Automática</span>';
                        this.toast("Ahorro de energía activado");
                    } else {
                        State.wakeLock = await navigator.wakeLock.request('screen');
                        btn.classList.remove('bg-slate-100', 'text-slate-500');
                        btn.classList.add('bg-emerald-100', 'text-emerald-700');
                        btn.innerHTML = '<i class="fas fa-sun"></i> <span>Mantener Pantalla: ON</span>';
                        this.toast("Pantalla se mantendrá encendida");
                    }
                } catch(e) { this.toast("No soportado en este dispositivo", "error"); }
            },

            nav(view) {
                State.view = view;
                this.toggleSidebar(false);
                document.querySelectorAll('.nav-item').forEach(el => {
                    el.classList.remove('active-nav', 'bg-slate-50', 'border-slate-500');
                    if (el.getAttribute('onclick').includes(view)) {
                        el.classList.add('bg-slate-50', 'border-slate-500');
                        el.querySelector('i').style.color = 'var(--primary)';
                    } else {
                        el.querySelector('i').style.color = '';
                    }
                });
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                document.getElementById(`view-${view}`).classList.remove('hidden');
                
                const titles = { tasks: 'Tareas', orders: 'Pedidos', delivery: 'Repartos', notes: 'Notas', procedures: 'Procesos', stock: 'Inventario', chat: 'Radio Frecuencia', scripts: 'Scripts Venta', standards: 'Catálogo Maestro' };
                document.getElementById('pageTitle').innerText = titles[view];
                
                if(view === 'chat') this.scrollToBottom('chatList');
            },

            openModal(id, data = null) {
                const modal = document.getElementById(id);
                const overlay = document.getElementById('modalOverlay');
                overlay.classList.remove('hidden');
                modal.classList.remove('hidden');
                requestAnimationFrame(() => {
                    modal.classList.remove('translate-y-full');
                    if(window.innerWidth >= 640) modal.classList.remove('sm:translate-y-full');
                });

                if (id === 'modal-tasks') {
                    const delBtn = document.getElementById('deleteTaskBtn');
                    if (data) {
                        document.getElementById('taskModalTitle').innerText = "Editar Tarea";
                        document.getElementById('taskId').value = data.id;
                        document.getElementById('taskInput').value = data.text;
                        document.getElementById('taskAssignee').value = data.assignee || '';
                        document.getElementById('taskPriority').value = data.priority || 'medium';
                        document.getElementById('taskCycle').value = data.cycle || 'none';
                        delBtn.classList.remove('hidden');
                        delBtn.onclick = () => window.delTask(data.id);
                    } else {
                        document.getElementById('taskModalTitle').innerText = "Nueva Tarea";
                        document.getElementById('taskId').value = '';
                        document.getElementById('taskInput').value = '';
                        document.getElementById('taskAssignee').value = State.username || '';
                        document.getElementById('taskCycle').value = 'none';
                        delBtn.classList.add('hidden');
                    }
                }
                
                if (id === 'modal-orders') {
                    document.getElementById('orderItemsContainer').innerHTML = '';
                    window.addOrderRow('orderItemsContainer'); 
                    document.getElementById('orderRequester').value = State.username || '';
                    document.getElementById('orderNotes').value = '';
                }

                if (id === 'modal-delivery') {
                    document.getElementById('delModalTitle').innerText = data ? "Editar Reparto" : "Nuevo Reparto";
                    document.getElementById('delId').value = data ? data.id : '';
                    document.getElementById('delItemsContainer').innerHTML = '';
                    
                    if (data && data.items && Array.isArray(data.items)) {
                         data.items.forEach(i => window.addOrderRow('delItemsContainer', i.item, i.amount));
                    } else if (data && data.items) {
                         window.addOrderRow('delItemsContainer', data.items, '1');
                    } else {
                         window.addOrderRow('delItemsContainer');
                    }

                    document.getElementById('delClient').value = data ? data.client : '';
                    document.getElementById('delPhone').value = data ? data.phone : '';
                    document.getElementById('delWhen').value = data ? data.when : '';
                    document.getElementById('delWhere').value = data ? data.where : '';
                    document.getElementById('delNotes').value = data ? (data.notes || '') : '';
                }
            },

            closeModal() {
                const overlay = document.getElementById('modalOverlay');
                const openModals = document.querySelectorAll('#modalOverlay > div:not(.hidden)');
                openModals.forEach(m => {
                    m.classList.add('translate-y-full');
                    if(window.innerWidth >= 640) m.classList.add('sm:translate-y-full');
                });
                setTimeout(() => {
                    overlay.classList.add('hidden');
                    openModals.forEach(m => m.classList.add('hidden'));
                }, 300);
            },

            handleFab() {
                const map = { tasks: 'modal-tasks', orders: 'modal-orders', delivery: 'modal-delivery', notes: 'modal-notes', procedures: 'modal-procedures', scripts: 'modal-scripts', standards: 'modal-standards' };
                if (map[State.view]) this.openModal(map[State.view]);
            },

            toast(msg, type='info') {
                const container = document.getElementById('toast-container');
                const el = document.createElement('div');
                const colors = { info: 'text-blue-400', success: 'text-emerald-400', error: 'text-red-400' };
                const icon = type === 'error' ? 'fa-exclamation-circle' : type === 'success' ? 'fa-check-circle' : 'fa-info-circle';
                el.className = 'toast';
                el.innerHTML = `<i class="fas ${icon} ${colors[type]}"></i> <span>${msg}</span>`;
                container.appendChild(el);
                setTimeout(() => {
                    el.style.opacity = '0';
                    el.style.transform = 'translateY(-10px)';
                    setTimeout(() => el.remove(), 300);
                }, 3000);
            },
            
            scrollToBottom(id) {
                const el = document.getElementById(id);
                if(el) el.scrollTop = el.scrollHeight;
            },

            renderStockList(query) {
                const container = document.getElementById('stockListContainer');
                container.innerHTML = '';
                const term = query.toLowerCase();
                const filtered = STOCK_DATA.filter(item => item.toLowerCase().includes(term));
                
                if (filtered.length === 0) {
                    container.innerHTML = '<div class="p-4 text-center text-slate-400 text-sm">No encontrado en el catálogo</div>';
                    return;
                }

                filtered.slice(0, 50).forEach(item => { // Limit to 50 for performance
                    const div = document.createElement('div');
                    div.className = "p-3 text-sm text-slate-700 hover:bg-slate-50";
                    div.innerText = item;
                    container.appendChild(div);
                });
            },

            // --- STANDARDS RENDER ---
            renderStandards(list) {
                const container = document.getElementById('standardsList');
                container.innerHTML = '';
                const groups = {};
                list.forEach(item => {
                    const species = item.species.toLowerCase();
                    if (!groups[species]) groups[species] = { name: item.species, variants: [] };
                    groups[species].variants.push(item);
                });

                if (Object.keys(groups).length === 0) {
                    container.innerHTML = this.emptyState('ruler-combined', 'Catálogo vacío');
                    return;
                }

                Object.values(groups).forEach(group => {
                    group.variants.sort((a, b) => a.sizeLabel.localeCompare(b.sizeLabel));
                    const card = document.createElement('div');
                    card.className = "bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden std-card";
                    card.dataset.species = group.name.toLowerCase(); 

                    const initial = group.variants[0];
                    const imgUrl = initial.photoUrl || 'https://placehold.co/600x400/e2e8f0/94a3b8?text=Sin+Foto';
                    const tabsHtml = group.variants.map((v, idx) => `<button onclick="window.switchStdTab(this, '${v.photoUrl||''}', '${v.height}', '${v.diameter}', '${v.author}', '${v.id}')" class="px-3 py-1 rounded-lg text-sm font-bold transition-colors ${idx === 0 ? 'bg-emerald-600 text-white shadow-md' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}">${v.sizeLabel}</button>`).join('');

                    card.innerHTML = `
                        <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                            <h3 class="font-bold text-slate-800 capitalize text-lg">${group.name}</h3>
                            <div class="flex gap-2 overflow-x-auto no-scrollbar">${tabsHtml}</div>
                        </div>
                        <div class="relative">
                            <img src="${imgUrl}" class="w-full h-64 object-cover std-img" id="img-${initial.id}">
                            <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black/80 to-transparent p-4 pt-12 text-white">
                                <div class="flex justify-between items-end">
                                    <div id="info-${initial.id}">
                                        <p class="font-bold text-lg"><i class="fas fa-arrows-alt-v opacity-70 w-5"></i> <span class="std-h">${initial.height}</span></p>
                                        <p class="font-bold text-lg"><i class="fas fa-circle-notch opacity-70 w-5"></i> <span class="std-d">${initial.diameter}</span></p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-xs opacity-70">Definido por</p>
                                        <p class="font-bold text-sm std-auth">${initial.author || 'Anónimo'}</p>
                                    </div>
                                </div>
                            </div>
                            <button onclick="window.delShared('standards', '${initial.id}')" class="absolute top-2 right-2 bg-white/20 hover:bg-red-500 hover:text-white text-white p-2 rounded-full backdrop-blur-sm transition std-del-btn" id="del-${initial.id}"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    container.appendChild(card);
                });
            },

            filterStandards(query) {
                const term = query.toLowerCase();
                document.querySelectorAll('.std-card').forEach(card => {
                    if (card.dataset.species.includes(term)) card.classList.remove('hidden');
                    else card.classList.add('hidden');
                });
            },

            renderTasks(tasks) {
                const list = document.getElementById('taskList');
                list.innerHTML = '';
                if(tasks.length === 0) { list.innerHTML = this.emptyState('relax', 'Todo listo por hoy'); return; }

                const prioColor = { critical: 'border-l-red-500', high: 'border-l-orange-500', medium: 'border-l-blue-500', low: 'border-l-emerald-500' };
                const prioText = { critical: 'URGENTE', high: 'ALTA', medium: 'MEDIA', low: 'BAJA' };

                const today = new Date().toDateString();

                tasks.forEach(t => {
                    // Logic for Cyclic Tasks Reset
                    let isDone = false;
                    if (t.cycle && t.cycle !== 'none') {
                        if (t.lastDone) {
                           const doneDate = new Date(t.lastDone.seconds * 1000).toDateString();
                           // If cyclic and done today, show done. Else show pending.
                           isDone = (doneDate === today); 
                        } else {
                           isDone = false;
                        }
                    } else {
                        // Normal task
                        isDone = t.status === 'done';
                    }

                    const isPartial = t.status === 'partial';
                    const cycleLabel = t.cycle && t.cycle !== 'none' ? `<span class="bg-indigo-100 text-indigo-700 text-[10px] px-2 py-0.5 rounded-full font-bold flex items-center gap-1"><i class="fas fa-sync-alt text-[8px]"></i> ${this.getCycleName(t.cycle)}</span>` : '';
                    
                    const div = document.createElement('div');
                    div.className = `bg-white rounded-xl p-4 shadow-sm border-l-4 ${prioColor[t.priority] || 'border-l-slate-300'} flex gap-3 transition-all ${isDone ? 'opacity-50' : ''}`;
                    
                    div.innerHTML = `
                        <div class="flex-grow">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">${prioText[t.priority] || 'NORMAL'}</span>
                                ${cycleLabel}
                                ${isPartial ? '<span class="text-[10px] bg-amber-100 text-amber-600 px-2 rounded-full font-bold">INCOMPLETO</span>' : ''}
                            </div>
                            <h3 class="text-slate-800 font-medium leading-tight ${isDone ? 'line-through text-slate-400' : ''}">${t.text}</h3>
                            <div class="flex items-center justify-between mt-2">
                                <span class="text-xs text-slate-400 flex items-center gap-1"><i class="fas fa-user-circle"></i> ${t.assignee || 'Sin asignar'}</span>
                                <button onclick='window.editTask(${JSON.stringify(t)})' class="text-slate-300 hover:text-slate-500 px-2"><i class="fas fa-ellipsis-h"></i></button>
                            </div>
                        </div>
                        <div class="flex flex-col gap-2 pt-1 border-l border-slate-100 pl-3">
                            ${!isDone ? `
                                <button onclick="window.updateTaskStatus('${t.id}', 'done', '${t.cycle}')" class="w-8 h-8 rounded-full bg-slate-100 text-slate-300 hover:bg-emerald-500 hover:text-white flex items-center justify-center transition-all shadow-sm active:scale-90" title="Completar"><i class="fas fa-check"></i></button>
                                ${!isPartial ? `<button onclick="window.updateTaskStatus('${t.id}', 'partial', '${t.cycle}')" class="w-8 h-8 rounded-full bg-slate-50 text-slate-300 hover:bg-amber-400 hover:text-white flex items-center justify-center transition-all active:scale-90" title="Marcar Incompleto"><i class="fas fa-hourglass-half text-xs"></i></button>` : ''}
                            ` : `<button onclick="window.updateTaskStatus('${t.id}', 'pending', '${t.cycle}')" class="w-8 h-8 rounded-full bg-emerald-500 text-white flex items-center justify-center shadow-md active:scale-90" title="Volver a Pendiente"><i class="fas fa-undo"></i></button>`}
                        </div>
                    `;
                    list.appendChild(div);
                });
            },

            getCycleName(c) {
                const map = { daily: 'Diario', weekly: 'Semanal', monthly: 'Mensual', quarterly: 'Trimestral' };
                return map[c] || c;
            },

            renderOrders(orders) {
                const list = document.getElementById('ordersList');
                list.innerHTML = '';
                const pending = orders.filter(o => o.status !== 'received').length;
                document.getElementById('badgeOrders').classList.toggle('hidden', pending === 0);

                if(orders.length === 0) { list.innerHTML = this.emptyState('shopping-basket', 'Sin pedidos pendientes'); return; }

                orders.forEach(o => {
                    const isReceived = o.status === 'received';
                    
                    const div = document.createElement('div');
                    div.className = `bg-white rounded-xl p-4 shadow-sm border border-slate-200 relative ${isReceived ? 'opacity-60 bg-slate-50' : ''}`;
                    
                    let statusBadge = isReceived ? '<span class="bg-emerald-100 text-emerald-700 text-xs px-2 py-1 rounded font-bold">RECIBIDO</span>' : 
                                      (o.status === 'ordered' ? '<span class="bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded font-bold">COMPRADO</span>' : '<span class="bg-slate-100 text-slate-500 text-xs px-2 py-1 rounded font-bold">PENDIENTE</span>');

                    let itemsHtml = '';
                    if (Array.isArray(o.items)) {
                        itemsHtml = `<div class="bg-slate-50 rounded-lg overflow-hidden my-2 border border-slate-100">${o.items.map(i => `<div class="flex justify-between p-2 border-b border-slate-100 last:border-0 text-sm"><span class="font-medium text-slate-700">${i.item}</span><span class="text-slate-500">x${i.amount}</span></div>`).join('')}</div>`;
                    } else { itemsHtml = `<div class="mb-2"><span class="font-bold text-lg text-slate-800">${o.item}</span> <span class="text-sm text-slate-500">x${o.amount}</span></div>`; }

                    div.innerHTML = `
                        <div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-slate-400 uppercase">Pedido</span>${statusBadge}</div>
                        ${itemsHtml}
                        ${o.notes ? `<p class="text-xs text-slate-500 italic mb-2"><i class="fas fa-comment-alt mr-1"></i>${o.notes}</p>` : ''}
                        <div class="flex justify-between items-center text-xs text-slate-400 mt-2 border-t border-slate-100 pt-2">
                            <span>Por: <strong>${o.requester}</strong> (${o.branch})</span>
                            <div class="flex gap-2">
                                ${!isReceived ? `<button onclick="window.advanceOrder('${o.id}', '${o.status}')" class="text-blue-600 font-bold hover:underline">AVANZAR</button>` : ''}
                                <button onclick="window.delShared('orders', '${o.id}')" class="text-red-400"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    `;
                    list.appendChild(div);
                });
            },

            renderDeliveries(items) {
                const list = document.getElementById('deliveryList');
                list.innerHTML = '';
                const pendingCount = items.filter(i => i.status === 'pending').length;
                document.getElementById('badgeDelivery').classList.toggle('hidden', pendingCount === 0);
                
                if(items.length === 0) { list.innerHTML = this.emptyState('truck', 'Nada para repartir'); return; }

                // Sort: Pending first, then by date desc (Newest pending at top of their section)
                items.sort((a,b) => {
                    if (a.status === 'pending' && b.status !== 'pending') return -1;
                    if (a.status !== 'pending' && b.status === 'pending') return 1;
                    return (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0);
                });

                items.forEach(d => {
                    const isDone = d.status === 'delivered';
                    const isIncomplete = d.status === 'incomplete';
                    const div = document.createElement('div');
                    div.className = `bg-white rounded-xl shadow-sm border overflow-hidden ${isDone ? 'opacity-50 border-slate-200' : isIncomplete ? 'border-orange-200 bg-orange-50' : 'border-slate-200'}`;
                    
                    const time = d.createdAt ? new Date(d.createdAt.seconds*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
                    
                    let itemsHtml = '';
                    if (Array.isArray(d.items)) {
                        itemsHtml = `<div class="bg-slate-50 rounded-lg p-2 text-sm text-slate-700 mb-3 border border-slate-100">${d.items.map(i => `<div class="flex justify-between border-b border-slate-200 last:border-0 py-1"><span>${i.item}</span><span class="font-bold">x${i.amount}</span></div>`).join('')}</div>`;
                    } else { itemsHtml = `<div class="bg-slate-50 p-3 rounded-lg border border-slate-100 text-sm text-slate-700 italic mb-3">${d.items}</div>`; }

                    div.innerHTML = `
                        <div class="p-4">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="font-bold text-slate-900">${d.client}</h3>
                                <div class="text-right">
                                    <span class="block text-xs font-bold text-slate-500 uppercase tracking-wide">${d.status === 'pending' ? 'Pendiente' : d.status === 'delivered' ? 'Entregado' : 'Incompleto'}</span>
                                    <span class="text-[10px] text-slate-400">${time}hs</span>
                                </div>
                            </div>
                            <div class="flex justify-between items-center mb-2">
                                <a href="tel:${d.phone}" class="text-emerald-600 text-sm font-bold flex items-center gap-1"><i class="fas fa-phone"></i> ${d.phone}</a>
                                <button onclick='window.editDelivery(${JSON.stringify(d)})' class="text-slate-300 hover:text-blue-500 text-sm p-1"><i class="fas fa-pencil-alt"></i></button>
                            </div>
                            ${itemsHtml}
                            ${d.notes ? `<p class="text-xs text-amber-600 bg-amber-50 p-2 rounded mb-3 border border-amber-100"><i class="fas fa-exclamation-circle"></i> ${d.notes}</p>` : ''}
                            <div class="flex gap-4 text-xs text-slate-500 font-medium">
                                <span class="flex items-center gap-1"><i class="far fa-clock"></i> ${d.when}</span>
                                <span class="flex items-center gap-1 text-blue-500"><i class="fas fa-map-marker-alt"></i> ${d.where}</span>
                            </div>
                        </div>
                        <div class="bg-slate-50 border-t border-slate-100 p-2 flex justify-between items-center">
                            <button onclick="window.delShared('deliveries', '${d.id}')" class="text-xs text-red-400 px-2">ELIMINAR</button>
                            <div class="flex gap-2">
                                ${(isDone || isIncomplete) ? `<button onclick="window.updateDelStatus('${d.id}', 'pending')" class="px-3 py-1 bg-slate-200 text-slate-600 rounded text-xs font-bold" title="Volver a Pendiente"><i class="fas fa-undo"></i></button>` : ''}
                                ${d.status !== 'incomplete' ? `<button onclick="window.updateDelStatus('${d.id}', 'incomplete')" class="px-3 py-1 bg-orange-100 text-orange-600 rounded text-xs font-bold">Incompleto</button>` : ''}
                                ${d.status !== 'delivered' ? `<button onclick="window.updateDelStatus('${d.id}', 'delivered')" class="px-3 py-1 bg-emerald-100 text-emerald-600 rounded text-xs font-bold">Entregado</button>` : ''}
                            </div>
                        </div>
                    `;
                    list.appendChild(div);
                });
            },

            renderNotes(notes) {
                const list = document.getElementById('notesList');
                list.innerHTML = '';
                notes.forEach(n => {
                    const isMoney = n.type === 'billing';
                    const div = document.createElement('div');
                    div.className = `p-4 rounded-xl shadow-sm border relative ${isMoney ? 'bg-amber-50 border-amber-200' : 'bg-yellow-50 border-yellow-200'}`;
                    div.innerHTML = `
                        ${isMoney ? '<span class="absolute -top-2 left-4 bg-amber-500 text-white text-[10px] px-2 rounded">COBRAR</span>' : ''}
                        <p class="whitespace-pre-wrap text-slate-800 leading-relaxed font-sans">${n.content}</p>
                        <button onclick="window.delItem('notes', '${n.id}')" class="absolute top-2 right-2 text-slate-400 hover:text-red-500 transition-colors w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50"><i class="fas fa-trash-alt"></i></button>
                    `;
                    list.appendChild(div);
                });
            },
            
            renderScripts(scripts) {
                const list = document.getElementById('scriptsList');
                list.innerHTML = '';
                if(scripts.length === 0) { list.innerHTML = this.emptyState('comment-dots', 'Sin scripts de venta'); return; }
                scripts.forEach(s => {
                    const div = document.createElement('div');
                    div.className = "bg-white rounded-xl shadow-sm border border-purple-100 p-4";
                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-slate-800 text-lg">${s.title}</h3>
                            <button onclick="window.delShared('scripts', '${s.id}')" class="text-slate-300 hover:text-red-400"><i class="fas fa-trash"></i></button>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-lg text-sm text-slate-600 mb-3 font-mono leading-relaxed border border-slate-100">${s.content}</div>
                        <button onclick="window.copyScript('${s.content.replace(/'/g, "\\'")}')" class="w-full py-2 bg-purple-100 text-purple-700 font-bold rounded-lg hover:bg-purple-200 transition flex items-center justify-center gap-2 active:scale-95"><i class="far fa-copy"></i> Copiar</button>
                    `;
                    list.appendChild(div);
                });
            },

            renderProcedures(procs) {
                const list = document.getElementById('proceduresList');
                list.innerHTML = '';
                const colors = { blue: 'bg-blue-50 border-blue-200 text-blue-900', green: 'bg-emerald-50 border-emerald-200 text-emerald-900', red: 'bg-red-50 border-red-200 text-red-900', purple: 'bg-purple-50 border-purple-200 text-purple-900', pink: 'bg-pink-50 border-pink-200 text-pink-900', teal: 'bg-teal-50 border-teal-200 text-teal-900', slate: 'bg-slate-100 border-slate-300 text-slate-800' };
                procs.forEach(p => {
                    const style = colors[p.color] || colors.blue;
                    const steps = p.steps.split('\n').map(s => `<li class="flex items-start gap-2 mb-1"><span class="mt-1.5 w-1.5 h-1.5 rounded-full bg-current opacity-50 flex-shrink-0"></span><span>${s.replace(/^- /, '')}</span></li>`).join('');
                    const div = document.createElement('div');
                    div.className = `rounded-xl shadow-sm border p-5 relative ${style}`;
                    div.innerHTML = `<h3 class="font-bold text-lg mb-3 flex items-center gap-2"><i class="fas fa-clipboard-check opacity-50"></i> ${p.title}</h3><ul class="text-sm opacity-90 leading-relaxed">${steps}</ul><button onclick="window.delShared('procedures', '${p.id}')" class="absolute top-4 right-4 opacity-30 hover:opacity-100 hover:text-red-600 transition"><i class="fas fa-trash"></i></button>`;
                    list.appendChild(div);
                });
            },

            renderChat(msgs) {
                const list = document.getElementById('chatList');
                list.innerHTML = '';
                msgs.forEach(m => {
                    const isMe = m.sender === State.user.uid;
                    const div = document.createElement('div');
                    div.className = `msg-bubble ${isMe ? 'msg-me' : 'msg-other'}`;
                    let content = '';
                    if(m.type === 'text') content = `<p>${m.text}</p>`;
                    if(m.type === 'image') content = `<img src="${m.url}" class="rounded-lg max-h-48 w-full object-cover" onclick="window.open(this.src)">`;
                    const time = m.createdAt ? new Date(m.createdAt.seconds*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '...';
                    const author = (!isMe && m.author) ? `<div class="text-[10px] font-bold opacity-60 mb-1 text-emerald-600">${m.author}</div>` : '';
                    div.innerHTML = `${author}${content}<div class="text-[10px] text-right mt-1 opacity-50">${time}</div>`;
                    list.appendChild(div);
                });
            },

            emptyState(icon, text) {
                return `<div class="flex flex-col items-center justify-center py-10 opacity-40 gap-3"><i class="fas fa-${icon} text-4xl"></i><p>${text}</p></div>`;
            }
        };
        window.UI = UI;

        // DATA MANAGER
        const Data = {
            getCol(name) { return collection(db, 'artifacts', APP_ID, 'public', 'data', name); },

            resubscribe() {
                // Safety timeout to kill loading if firebase hangs
                setTimeout(() => document.getElementById('loadingIndicator').classList.add('hidden'), 3000);

                Object.values(State.listeners).forEach(u => u && u());
                State.listeners.tasks = onSnapshot(this.getCol('tasks'), (snap) => {
                    const tasks = []; 
                    snap.forEach(d => { if (d.data().branch === State.branch) tasks.push({id: d.id, ...d.data()}); });
                    const pVal = {critical:0, high:1, medium:2, low:3};
                    tasks.sort((a,b) => { if(pVal[a.priority] !== pVal[b.priority]) return pVal[a.priority] - pVal[b.priority]; return (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0); });
                    UI.renderTasks(tasks);
                });
                State.listeners.notes = onSnapshot(this.getCol('notes'), (snap) => {
                    const items = []; snap.forEach(d => { if (d.data().branch === State.branch) items.push({id: d.id, ...d.data()}); });
                    UI.renderNotes(items.sort((a,b) => (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0)));
                });
                State.listeners.chat = onSnapshot(this.getCol('chat'), (snap) => {
                    const items = []; snap.forEach(d => { if (d.data().branch === State.branch) items.push({id: d.id, ...d.data()}); });
                    UI.renderChat(items.sort((a,b) => (a.createdAt?.seconds||0)-(b.createdAt?.seconds||0)));
                });
                State.listeners.delivery = onSnapshot(this.getCol('deliveries'), (snap) => {
                    const items = []; snap.forEach(d => items.push({id: d.id, ...d.data()}));
                    UI.renderDeliveries(items); 
                });
                State.listeners.procedures = onSnapshot(this.getCol('procedures'), (snap) => {
                    const items = []; snap.forEach(d => items.push({id: d.id, ...d.data()}));
                    UI.renderProcedures(items.sort((a,b) => (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0)));
                });
                State.listeners.scripts = onSnapshot(this.getCol('scripts'), (snap) => {
                    const items = []; snap.forEach(d => items.push({id: d.id, ...d.data()}));
                    UI.renderScripts(items.sort((a,b) => (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0)));
                });
                State.listeners.standards = onSnapshot(this.getCol('standards'), (snap) => {
                    const items = []; snap.forEach(d => items.push({id: d.id, ...d.data()}));
                    UI.renderStandards(items);
                });
                State.listeners.orders = onSnapshot(this.getCol('orders'), (snap) => {
                    const items = []; snap.forEach(d => items.push({id: d.id, ...d.data()}));
                    UI.renderOrders(items.sort((a,b) => (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0)));
                });
            }
        };

        // GLOBAL ACTIONS
        window.updateTaskStatus = async (id, status, cycle) => { 
            const update = { status };
            if (status === 'done' && cycle && cycle !== 'none') {
                 update.lastDone = serverTimestamp(); // Save completion time
            }
            try { await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'tasks', id), update); } catch(e) { UI.toast('Error', 'error'); } 
        };
        window.editTask = (task) => { UI.openModal('modal-tasks', task); };
        window.editDelivery = (delivery) => { UI.openModal('modal-delivery', delivery); };
        window.delTask = async (id) => { if(confirm('¿Eliminar esta tarea definitivamente?')) { UI.closeModal(); await deleteDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'tasks', id)); UI.toast("Tarea eliminada"); } };
        window.delItem = async (col, id) => { if(confirm('¿Eliminar?')) await deleteDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', col, id)); };
        window.delShared = async (col, id) => { if(confirm('¿Eliminar Global?')) await deleteDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', col, id)); };
        window.updateDelStatus = async (id, status) => { await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'deliveries', id), { status }); };
        window.advanceOrder = async (id, current) => { const next = current === 'pending' ? 'ordered' : 'received'; await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'orders', id), { status: next }); };
        window.copyScript = (text) => { if (navigator.clipboard) { navigator.clipboard.writeText(text).then(() => UI.toast("¡Copiado!", "success")); } else { const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); UI.toast("¡Copiado!", "success"); } };
        window.downloadBackup = async () => { UI.toast("Generando Backup..."); const backup = {}; const cols = ['tasks', 'notes', 'chat', 'orders', 'deliveries', 'procedures', 'scripts', 'standards']; for (const c of cols) { const snap = await getDocs(collection(db, 'artifacts', APP_ID, 'public', 'data', c)); backup[c] = []; snap.forEach(d => backup[c].push({id: d.id, ...d.data()})); } const blob = new Blob([JSON.stringify(backup, null, 2)], {type : 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `backup_jardin_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); UI.toast("Backup Descargado", "success"); };
        
        window.switchStdTab = (btn, photo, h, d, auth, id) => { const card = btn.closest('.std-card'); card.querySelectorAll('button').forEach(b => { b.classList.remove('bg-emerald-600', 'text-white', 'shadow-md'); b.classList.add('bg-slate-100', 'text-slate-500'); }); btn.classList.remove('bg-slate-100', 'text-slate-500'); btn.classList.add('bg-emerald-600', 'text-white', 'shadow-md'); const img = card.querySelector('.std-img'); img.src = photo || 'https://placehold.co/600x400/e2e8f0/94a3b8?text=Sin+Foto'; card.querySelector('.std-h').innerText = h; card.querySelector('.std-d').innerText = d; card.querySelector('.std-auth').innerText = auth || 'Anónimo'; card.querySelector('.std-del-btn').onclick = () => window.delShared('standards', id); };
        window.previewStdImage = (input) => { const file = input.files[0]; if(file) { const reader = new FileReader(); reader.onload = (e) => { const prev = document.getElementById('stdPhotoPreview'); prev.style.backgroundImage = `url(${e.target.result})`; prev.classList.remove('hidden'); document.getElementById('stdPhotoPlaceholder').classList.add('hidden'); }; reader.readAsDataURL(file); } };
        window.handleChatImage = async (input) => { const file = input.files[0]; if(!file) return; UI.toast('Subiendo imagen...'); try { const storageRef = ref(storage, `chat/${Date.now()}_${file.name}`); const snap = await uploadBytes(storageRef, file); const url = await getDownloadURL(snap.ref); await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'chat'), { type: 'image', url, sender: State.user.uid, author: State.username, branch: State.branch, createdAt: serverTimestamp() }); UI.toast('Enviado', 'success'); } catch(e) { UI.toast('Error subida', 'error'); } input.value = ''; };

        // DYNAMIC ROW ADDER FOR ORDERS & DELIVERIES
        window.addOrderRow = (containerId = 'orderItemsContainer', val='', amount='') => {
            const container = document.getElementById(containerId);
            const row = document.createElement('div');
            row.className = 'flex gap-2 mb-2 order-row';
            row.innerHTML = `<input type="text" list="stockItemsList" value="${val}" class="order-item w-[70%] p-2 bg-slate-50 rounded-lg border border-slate-200 text-sm outline-none" placeholder="Item"><input type="text" value="${amount}" class="order-amount w-[20%] p-2 bg-slate-50 rounded-lg border border-slate-200 text-sm outline-none" placeholder="#"><button onclick="this.parentElement.remove()" class="w-[10%] text-red-400 hover:text-red-600"><i class="fas fa-times"></i></button>`;
            container.appendChild(row);
        };

        // SAVE BUTTONS
        document.getElementById('saveStdBtn').onclick = async () => { const species = document.getElementById('stdSpecies').value.trim(); const height = document.getElementById('stdHeight').value.trim(); const diameter = document.getElementById('stdDiameter').value.trim(); const file = document.getElementById('stdPhotoInput').files[0]; const sizeLabel = document.querySelector('input[name="stdSize"]:checked').value; if(!species) return UI.toast('Falta Especie', 'error'); let photoUrl = ''; if (file) { UI.toast("Subiendo foto..."); try { const storageRef = ref(storage, `standards/${Date.now()}_${file.name}`); const snap = await uploadBytes(storageRef, file); photoUrl = await getDownloadURL(snap.ref); } catch(e) { return UI.toast("Error subiendo foto", "error"); } } await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'standards'), { species: species.charAt(0).toUpperCase() + species.slice(1), sizeLabel, height, diameter, photoUrl, author: State.username, branch: State.branch, createdAt: serverTimestamp() }); UI.closeModal(); UI.toast("Estándar guardado", "success"); };
        document.getElementById('saveTaskBtn').onclick = async () => { const id = document.getElementById('taskId').value; const text = document.getElementById('taskInput').value.trim(); if(!text) return UI.toast('Falta descripción', 'error'); UI.closeModal(); const data = { text, assignee: document.getElementById('taskAssignee').value.trim(), priority: document.getElementById('taskPriority').value, cycle: document.getElementById('taskCycle').value, branch: State.branch, updatedAt: serverTimestamp() }; if(id) { await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'tasks', id), data); UI.toast('Tarea actualizada', 'success'); } else { data.status = 'pending'; data.createdAt = serverTimestamp(); await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'tasks'), data); UI.toast('Tarea creada', 'success'); } };
        
        document.getElementById('saveOrderBtn').onclick = async () => {
             const rows = document.querySelectorAll('#orderItemsContainer .order-row');
             const items = []; rows.forEach(r => { const item = r.querySelector('.order-item').value.trim(); const amount = r.querySelector('.order-amount').value.trim(); if(item) items.push({item, amount}); });
             if(items.length === 0) return UI.toast('Agrega al menos un item', 'error');
             UI.closeModal();
             await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'orders'), { items, requester: document.getElementById('orderRequester').value, notes: document.getElementById('orderNotes').value, branch: State.branch === 'centro' ? 'Centro' : 'Ejemplares', status: 'pending', createdAt: serverTimestamp() });
             UI.toast('Pedido enviado', 'success');
        };

        document.getElementById('saveDelBtn').onclick = async () => {
            const rows = document.querySelectorAll('#delItemsContainer .order-row');
            const items = []; rows.forEach(r => { const item = r.querySelector('.order-item').value.trim(); const amount = r.querySelector('.order-amount').value.trim(); if(item) items.push({item, amount}); });
            if(items.length === 0) return UI.toast('Agrega al menos un item', 'error');
            UI.closeModal();
            
            const data = {
                client: document.getElementById('delClient').value,
                phone: document.getElementById('delPhone').value,
                items, 
                notes: document.getElementById('delNotes').value, 
                when: document.getElementById('delWhen').value,
                where: document.getElementById('delWhere').value,
                branchOrigin: State.branch,
                updatedAt: serverTimestamp()
            };
            
            const id = document.getElementById('delId').value;
            if(id) {
                await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'deliveries', id), data);
                UI.toast('Reparto actualizado', 'success');
            } else {
                data.status = 'pending';
                data.createdAt = serverTimestamp();
                await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'deliveries'), data);
                UI.toast('Reparto agendado', 'success');
            }
        };

        document.getElementById('saveNoteBtn').onclick = async () => { const content = document.getElementById('noteContent').value.trim(); if(!content) return; UI.closeModal(); await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'notes'), { content, type: document.getElementById('noteType').value, branch: State.branch, createdAt: serverTimestamp() }); };
        document.getElementById('saveProcBtn').onclick = async () => { const title = document.getElementById('procTitle').value; const steps = document.getElementById('procSteps').value; if(!title) return; UI.closeModal(); const color = document.querySelector('input[name="procColor"]:checked').value; await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'procedures'), { title, steps, color, createdAt: serverTimestamp() }); };
        document.getElementById('saveScriptBtn').onclick = async () => { const title = document.getElementById('scriptTitle').value.trim(); const content = document.getElementById('scriptContent').value.trim(); if(!title || !content) return UI.toast('Faltan datos', 'error'); UI.closeModal(); await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'scripts'), { title, content, createdAt: serverTimestamp() }); UI.toast('Script guardado', 'success'); };
        document.getElementById('sendChatBtn').onclick = async () => { const input = document.getElementById('chatTextInput'); const text = input.value.trim(); if(!text) return; input.value = ''; await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'chat'), { type: 'text', text, sender: State.user.uid, author: State.username, branch: State.branch, createdAt: serverTimestamp() }); };

        onAuthStateChanged(auth, async (user) => {
            const ind = document.getElementById('connectionStatus');
            if (user) { State.user = user; ind.innerText = "Conectado"; document.getElementById('loadingIndicator').classList.remove('hidden'); Data.resubscribe(); setTimeout(() => document.getElementById('loadingIndicator').classList.add('hidden'), 1000); }
            else { ind.innerText = "Desconectado"; if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token); else await signInAnonymously(auth); }
        });
        UI.init();
    </script>
</body>
</html>
